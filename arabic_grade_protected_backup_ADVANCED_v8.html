<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>دفتر متابعة اللغة العربية - الأستاذ إبراهيم أحمد متاش</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@600&display=swap');
    body {
      font-family: 'Cairo', Tahoma, Arial, sans-serif;
      background: #f6f6f6;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 98vw;
      margin: 18px auto;
      background: #fff;
      padding: 22px 10px;
      border-radius: 15px;
      box-shadow: 0 4px 16px #00000017;
      position: relative;
      border: 2.5px solid #198754;
    }
    .header-flex {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
      gap: 12px;
    }
    .header-flex .teacher {
      font-size: 22px;
      color: #198754;
      font-weight: bold;
      white-space: nowrap;
      letter-spacing: 1px;
      text-shadow: 0 1px 0 #bdf4c3;
    }
    .header-flex .month-box {
      font-size: 19px;
      display: flex;
      align-items: center;
      gap: 7px;
      font-weight: 700;
      color: #194;
    }
    .header-flex .month-box input[type="text"] {
      font-size: 17px;
      width: 135px;
      padding: 5px 10px;
      border-radius: 7px;
      border: 1.5px solid #198754;
      text-align: right;
      background: #f8f8f8;
      font-weight: 700;
    }
    .class-row {
      margin: 18px auto 16px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
    }
    .class-row .class-label {
      font-size: 19px;
      color: #0d6efd;
      font-weight: bold;
      margin-left: 7px;
      letter-spacing: 1px;
    }
    .class-row input[type="text"] {
      font-size: 18px;
      width: 320px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 2px solid #198754;
      background: #fafdff;
      text-align: right;
      font-weight: bold;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .class-row .info {
      font-size: 14px;
      color: #b91c1c;
      font-weight: bold;
      margin-right: 14px;
      display: none;
    }
    .class-row .info.active {
      display: inline-block;
      animation: fadeIn 0.6s;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    h1 {
      margin: 10px 0 18px 0;
      text-align: center;
      font-weight: 900;
      font-size: 27px;
      color: #198754;
      letter-spacing: 2px;
      text-shadow: 0 2px 0 #d1e7dd;
    }
    .btns {
      margin: 0 0 20px 0;
      text-align: center;
      gap: 12px;
    }
    .btns button {
      font-size: 16px;
      padding: 8px 28px;
      margin: 0 6px;
      border: 0;
      border-radius: 8px;
      background: linear-gradient(90deg, #198754 80%, #1d8b6d 100%);
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
      box-shadow: 0 2px 10px #0000000a;
    }
    .btns button:hover {
      background: linear-gradient(90deg, #13633b 80%, #1a6953 100%);
    }
    .btns .backup-btn {
      background: #0d6efd;
      margin-right: 8px;
    }
    .btns .backup-btn:hover {
      background: #1552b5;
    }
    .btns .restore-btn {
      background: #fbbf24;
      color: #222;
      margin-right: 2px;
    }
    .btns .restore-btn:hover {
      background: #b98a13;
      color: #fff;
    }
    .reset-btn {
      background: #ef4444;
      color: #fff;
      margin-right: 10px;
      font-weight: bold;
      font-size: 15px;
      border-radius: 8px;
      padding: 8px 24px;
      border: none;
      cursor: pointer;
      transition: 0.18s;
      position: relative;
      z-index: 2;
    }
    .reset-btn:hover {
      background: #b91c1c;
    }
    table {
      direction: rtl;
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 13.2px;
      margin-bottom: 14px;
      page-break-inside: avoid;
      box-shadow: 0 2px 10px #0001;
    }
    th, td {
      border: 1px solid #198754;
      padding: 3px 2px;
      text-align: center;
      font-size: 13px;
      white-space: nowrap;
      vertical-align: middle;
    }
    th {
      background: linear-gradient(90deg, #d1e7dd 80%, #c4e7c7 100%);
      color: #1d513a;
      font-weight: 900;
      font-size: 13.5px;
      letter-spacing: 0.5px;
    }
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    .serial-cell {
      color: #888;
      font-weight: bold;
      width: 24px;
      min-width: 18px;
      max-width: 28px;
      text-align: center !important;
    }
    .student-name-cell input[type="text"] {
      width: 330px !important;
      min-width: 160px;
      max-width: 600px;
      font-size: 13.5px;
      font-weight: bold;
      padding: 3px 6px;
      background: #f3f4f6;
      border: 1.5px solid #198754;
      border-radius: 7px;
      direction: rtl;
      text-align: right;
    }
    td input[type="number"] {
      width: 32px !important;
      min-width: 20px;
      max-width: 38px;
      font-size: 13px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #198754;
      background: #fafdff;
    }
    .written {
      width: 44px !important;
      max-width: 60px !important;
      text-align: center;
    }
    .sum-cell {
      font-size: 15px !important;
      font-weight: bold;
      background: #e0f2fe !important;
      color: #0a3466 !important;
      width: 38px !important;
      min-width: 36px !important;
      max-width: 46px !important;
      letter-spacing: 0.5px;
      border: 2px solid #1a856d;
    }
    .grade-estimate {
      min-width: 48px !important;
      max-width: 86px !important;
    }
    .note-cell textarea {
      width: 110px !important;
      min-width: 80px;
      max-width: 160px;
      height: 32px !important;
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 7px;
      background: #f1f5f9;
      border: 1.3px solid #bdbdbd;
      direction: rtl;
      resize: vertical;
      text-align: center;
    }
    .note-head {
      background: #fee2e2;
      font-size: 13px;
    }
    .grade-badge {
      font-weight: bold;
      border-radius: 15px;
      font-size: 12.5px;
      padding: 2px 12px;
      display: inline-block;
      margin: 0 auto;
      box-shadow: 0 1px 4px #19875422;
    }
    .badge-excellent    { background: #22d3ee; color: #055160;}
    .badge-vgood        { background: #7ed957; color: #205800;}
    .badge-good         { background: #fde047; color: #7d5900;}
    .badge-acceptable   { background: #fbbf24; color: #7d4700;}
    .badge-weak         { background: #ef4444; color: #fff;}
    .grade-color-excellent    { background: #a7f3d0 !important; }
    .grade-color-vgood        { background: #dbeafe !important; }
    .grade-color-good         { background: #fef9c3 !important; }
    .grade-color-acceptable   { background: #fde68a !important; }
    .grade-color-weak         { background: #fee2e2 !important; }
    .footer-bar {
      width: 100%;
      text-align: center;
      color: #fff;
      background: #198754;
      font-size: 16px;
      font-weight: bold;
      padding: 8px 0 7px 0;
      letter-spacing: 1px;
      position: fixed;
      bottom: 0; left: 0; z-index: 1;
      border-top: 2px solid #23d39a;
      box-shadow: 0 -2px 8px #23d39a22;
    }
    .modal-confirm-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 10001 !important;
      background: rgba(0,0,0,0.17);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-confirm-box {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 22px #0002;
      padding: 33px 30px 24px 30px;
      min-width: 310px;
      max-width: 96vw;
      text-align: center;
      font-family: 'Cairo', Tahoma, Arial, sans-serif;
      position: relative;
      z-index: 10002 !important;
    }
    .modal-confirm-box h2 {
      font-size: 20px;
      color: #b91c1c;
      margin-bottom: 14px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .modal-confirm-box .modal-msg {
      font-size: 15px;
      color: #222;
      margin-bottom: 17px;
      font-weight: normal;
    }
    .modal-confirm-box button {
      font-size: 15px;
      padding: 6px 28px;
      border-radius: 8px;
      margin: 0 8px;
      font-weight: bold;
      outline: none;
      border: 0;
      cursor: pointer;
      transition: 0.16s;
    }
    .modal-confirm-box .yes { background: #198754; color: #fff; }
    .modal-confirm-box .yes:hover { background: #14563e;}
    .modal-confirm-box .no { background: #fbbf24; color: #444;}
    .modal-confirm-box .no:hover { background: #b98a13; color: #fff;}
    .watermark {
      display: none;
    }
    .chart-section {
      margin: 20px 0 0 0;
      text-align: center;
      width: 100%;
    }
    .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #curveChart {
      max-width: 350px;
      max-height: 140px;
      background: #fafdff;
      border-radius: 10px;
      box-shadow: 0 1px 4px #19875422;
      margin: 0 auto;
    }
    @media print {
      table {
        font-size: 10.5px !important;
        table-layout: auto !important;
      }
      th, td {
        word-break: break-word !important;
        overflow: hidden !important;
        white-space: normal !important;
        padding: 2px 2px !important;
        text-align: center !important;
        vertical-align: middle !important;
      }
      th.student-name-cell, td.student-name-cell {
        width: 38% !important;
        min-width: 200px !important;
        max-width: 520px !important;
        text-align: right !important;
        font-size: 12.5px !important;
      }
      th.serial-cell, td.serial-cell {
        width: 4% !important;
        min-width: 16px !important;
        max-width: 28px !important;
      }
      th.sum-cell, td.sum-cell,
      th.grade-estimate, td.grade-estimate {
        width: 38px !important;
        min-width: 36px !important;
        max-width: 86px !important;
      }
      th:not(.student-name-cell):not(.serial-cell):not(.sum-cell):not(.grade-estimate),
      td:not(.student-name-cell):not(.serial-cell):not(.sum-cell):not(.grade-estimate) {
        width: 3.5% !important;
        min-width: 19px !important;
        max-width: 44px !important;
      }
      td input, td textarea {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        background: #fff !important;
        border: none !important;
        font-size: 10.5px !important;
        text-align: center !important;
      }
      body, .container { background: #fff !important; }
      .btns, .header-flex, .reset-btn, .footer-bar { display: none !important; }
      .class-row { margin-top: 0; margin-bottom: 10px;}
      input, textarea { border: none !important; background: #fff !important; }
      .page-break { display: block; page-break-after: always; }
      .print-header { display: table-header-group !important; }
      .print-footer { display: table-footer-group !important; }
      .watermark {
        display: block !important;
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0.23;
        font-size: 28px;
        color: #198754;
        z-index: 9999;
        font-weight: bold;
        pointer-events: none;
        width: 100vw;
        text-align: center;
      }
      #curveChartSection { 
        display: block !important;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100vw !important;
        max-width: 100vw !important;
        background: #fff !important;
        page-break-after: avoid;
      }
      #curveChart {
        max-width: 340px !important;
        max-height: 120px !important;
        margin: 0 auto !important;
        display: block !important;
      }
      @page {
        size: A4 landscape;
        margin: 7mm 7mm 7mm 7mm;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="lock-screen" id="lockScreen">
  <div class="lock-box">
    <h2>نموذج محمي<br>يرجى إدخال كلمة المرور</h2>
    <input type="password" id="lockPass" placeholder="كلمة المرور..." autocomplete="off" onkeydown="if(event.key==='Enter'){unlock()}" />
    <br>
    <button onclick="unlock()">دخول</button>
    <div class="lock-error" id="lockError"></div>
    <div style="margin-top:11px;font-size:13px;color:#555;">جميع الحقوق محفوظة للأستاذ إبراهيم أحمد متاش</div>
  </div>
</div>
<div id="mainApp" style="display:none">
  <div class="container">
    <div class="header-flex">
      <div class="teacher">دفتر متابعة اللغة العربية - الأستاذ إبراهيم أحمد متاش</div>
      <div class="month-box">
        الشهر:
        <input type="text" id="monthName" placeholder="مثال: مارس 2025" />
      </div>
    </div>
    <div class="class-row">
      <span class="class-label">الصف:</span>
      <input type="text" id="className" placeholder="مثال: الصف السابع" oninput="onClassNameInput()" />
      <span class="info" id="classWarning"></span>
      <button class="reset-btn" onclick="resetAllData()" title="بدء جديد (حذف جميع البيانات)">بدء جديد</button>
    </div>
    <h1>متابعة تصحيح دفاتر الطلاب لمادة اللغة العربية</h1>
    <div class="btns">
      <button onclick="calculateTotals();">احتسب الدرجات</button>
      <button onclick="exportPdf()">تصدير PDF</button>
      <button onclick="exportTableToExcel('gradesTableContainer','دفتر تصحيح اللغة العربية')">تصدير Excel</button>
      <button onclick="addRow()">إضافة طالب</button>
      <button class="backup-btn" onclick="exportBackup()">حفظ نسخة احتياطية</button>
      <input type="file" id="importBackupInput" style="display:none" onchange="importBackup(event)">
      <button class="restore-btn" onclick="document.getElementById('importBackupInput').click()">استيراد نسخة احتياطية</button>
    </div>
    <div id="gradesTableContainer"></div>
    <div class="chart-section" id="curveChartSection" style="margin:18px auto 0 auto; text-align:center;">
      <h2 style="font-size:14px;color:#0d6efd;margin-bottom:6px;">منحنى تركز الدرجات الأعلى للطلاب</h2>
      <div class="chart-container" style="display:flex;justify-content:center;">
        <canvas id="curveChart" style="max-width:350px;max-height:140px;background:#fafdff;border-radius:10px;box-shadow:0 1px 4px #19875422;"></canvas>
      </div>
    </div>
  </div>
  <div class="footer-bar">
    جميع الحقوق محفوظة © للأستاذ إبراهيم أحمد متاش - لا يجوز إعادة النشر أو التعديل إلا بإذن خطي
  </div>
  <div class="watermark">تصميم الأستاذ إبراهيم أحمد متاش</div>
</div>
<div id="modalConfirmRoot"></div>
<script>
const PASSWORD = "arabicgrade2025";
function unlock() {
  let pass = document.getElementById('lockPass').value.trim();
  let err = document.getElementById('lockError');
  if(pass === PASSWORD) {
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = '';
    document.body.style.overflow = '';
    setTimeout(()=>{document.getElementById('className').focus()},200);
  } else {
    err.innerText = "كلمة المرور غير صحيحة!";
    document.getElementById('lockPass').value = '';
  }
}
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('lockPass').focus();
  document.body.style.overflow = 'hidden';
});

function showConfirmModal(title, message, onConfirm) {
  let root = document.getElementById("modalConfirmRoot");
  root.innerHTML = '';
  let modal = document.createElement("div");
  modal.className = "modal-confirm-bg";
  modal.innerHTML = `<div class="modal-confirm-box">
    <h2>${title}</h2>
    <div class="modal-msg">${message}</div>
    <button class="yes">موافق</button>
    <button class="no">إلغاء</button>
  </div>`;
  modal.querySelector('.yes').onclick = function() {
    root.innerHTML = '';
    onConfirm();
  };
  modal.querySelector('.no').onclick = function() {
    root.innerHTML = '';
  };
  root.appendChild(modal);
}

let studentRows = [];
const ROWS_PER_PAGE = 20;
const baseDistributions = {
  "السابع": { act2_1: 2, act2_2: 2, reading: 2, memorize: 2, act5: 5, hw: [4,4,4,4], handwriting: 4, dictation: 4, written: 60 },
  "الثامن": { act2_1: 2, act2_2: 2, reading: 2, memorize: 2, act5: 5, hw: [4,4,4,4], handwriting: 4, dictation: 4, written: 60 },
  "التاسع": { act2_1: 1, act2_2: 1, reading: 2, memorize: 2, act5: 3, hw: [3,3,3,3], handwriting: 3, dictation: 4, written: 70 }
};
function getCurrentDistribution() {
  const className = (document.getElementById('className').value || '').trim();
  if (className.includes('تاسع')) return {...baseDistributions["التاسع"]};
  if (className.includes('ثامن')) return {...baseDistributions["الثامن"]};
  if (className.includes('سابع')) return {...baseDistributions["السابع"]};
  return {...baseDistributions["السابع"]};
}
function getAdjustedDistribution() {
  let dist = getCurrentDistribution();
  let total = dist.act2_1 + dist.act2_2 + dist.reading + dist.memorize + dist.act5 + dist.hw.reduce((a,b)=>a+b,0) + dist.handwriting + dist.dictation + dist.written;
  let written10 = Math.floor(dist.written / 10) * 10;
  let diff = dist.written - written10;
  let act5 = dist.act5 + diff + (100 - (total - dist.written + written10));
  return {
    ...dist,
    written: written10,
    act5: parseFloat(act5.toFixed(2))
  };
}
let currentClassKey = "";
function onClassNameInput() {
  const classInput = document.getElementById('className');
  const classWarning = document.getElementById('classWarning');
  const newKey =
    classInput.value.includes('تاسع') ? "التاسع" :
    classInput.value.includes('ثامن') ? "الثامن" :
    classInput.value.includes('سابع') ? "السابع" : "default";
  if (currentClassKey && currentClassKey !== newKey && studentRows.length > 0) {
    classInput.classList.add('pending-warning');
    classWarning.innerText = "تنبيه: تغيير الصف سيغير توزيع الدرجات، وقد يسبب اختلاف في بيانات الطلاب الحالية. هل تريد المتابعة؟";
    classWarning.classList.add('active');
    showConfirmModal(
      "تغيير الصف",
      "سيتم تغيير توزيع الدرجات وفقًا للصف الجديد، وقد تتعرض بيانات الطلاب الحالية للخلط أو فقدان بعض القيم. هل ترغب بالمتابعة؟",
      function() {
        currentClassKey = newKey;
        classInput.classList.remove('pending-warning');
        classWarning.innerText = "";
        classWarning.classList.remove('active');
        renderTablePages();
        calculateTotals();
        saveTableToStorage();
      }
    );
  } else {
    currentClassKey = newKey;
    classInput.classList.remove('pending-warning');
    classWarning.innerText = "";
    classWarning.classList.remove('active');
    renderTablePages();
    calculateTotals();
    saveTableToStorage();
  }
}

function renderTablePages() {
  const gradesTableContainer = document.getElementById('gradesTableContainer');
  gradesTableContainer.innerHTML = '';
  let n = studentRows.length;
  let pages = Math.ceil(n / ROWS_PER_PAGE);
  const dist = getAdjustedDistribution();

  function tdDist(val, fallback) {
    return `<span style="font-size:11px;color:#0d6efd;">(${val || fallback})</span>`;
  }
  for (let p = 0; p < pages; p++) {
    let start = p * ROWS_PER_PAGE;
    let end = Math.min((p + 1) * ROWS_PER_PAGE, n);
    let table = document.createElement('table');
    table.id = (p === 0 ? "gradesTable" : "");
    table.innerHTML = `
      <thead class="${p === 0 ? 'print-header' : ''}">
        <tr>
          <th class="serial-cell">م</th>
          <th class="student-name-cell" rowspan="2" style="background:#d1e7dd;min-width:180px;max-width:400px;">اسم الطالب الرباعي</th>
          <th colspan="2">نشاط ${tdDist(dist.act2_1,2)+tdDist(dist.act2_2,2)}</th>
          <th>قراءة ${tdDist(dist.reading,2)}</th>
          <th>تسميع ${tdDist(dist.memorize,2)}</th>
          <th>نش.صفي ${tdDist(dist.act5,5)}</th>
          <th colspan="4">واجب ${tdDist(dist.hw[0],4)+tdDist(dist.hw[1],4)+tdDist(dist.hw[2],4)+tdDist(dist.hw[3],4)}</th>
          <th>خط ${tdDist(dist.handwriting,4)}</th>
          <th>إملاء ${tdDist(dist.dictation,4)}</th>
          <th class="sum-cell">نش+</th>
          <th class="sum-cell">واج+</th>
          <th class="sum-cell">تحر${tdDist(dist.written,60)}</th>
          <th class="sum-cell">المج</th>
          <th class="grade-estimate">تقدير</th>
          <th class="note-head">ملاحظات</th>
        </tr>
        <tr>
          <th></th>
          <th>1</th>
          <th>2</th>
          <th></th>
          <th></th>
          <th></th>
          <th>1</th>
          <th>2</th>
          <th>3</th>
          <th>4</th>
          <th></th>
          <th></th>
          <th class="sum-cell"></th>
          <th class="sum-cell"></th>
          <th class="sum-cell"></th>
          <th class="sum-cell"></th>
          <th class="grade-estimate"></th>
          <th class="note-head"></th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    `;
    for(let i = start; i < end; i++) {
      let row = studentRows[i];
      let tr = document.createElement('tr');
      tr.className = row.gradeClass || '';
      tr.innerHTML = `
        <td class="serial-cell">${i+1}</td>
        <td class="student-name-cell">
          <input type="text" value="${row.name || ''}" maxlength="80"
           oninput="studentRows[${i}].name=this.value;saveTableToStorage();">
        </td>
        <td><input type="number" min="0" max="${dist.act2_1}" step="0.5" class="activity2" value="${row.act2_1 || ''}" oninput="updateRow(${i}, 'act2_1', this.value)"></td>
        <td><input type="number" min="0" max="${dist.act2_2}" step="0.5" class="activity2" value="${row.act2_2 || ''}" oninput="updateRow(${i}, 'act2_2', this.value)"></td>
        <td><input type="number" min="0" max="${dist.reading}" step="0.5" class="reading2" value="${row.reading || ''}" oninput="updateRow(${i}, 'reading', this.value)"></td>
        <td><input type="number" min="0" max="${dist.memorize}" step="0.5" class="memorize2" value="${row.memorize || ''}" oninput="updateRow(${i}, 'memorize', this.value)"></td>
        <td><input type="number" min="0" max="${dist.act5}" step="0.5" class="activity5" value="${row.act5 || ''}" oninput="updateRow(${i}, 'act5', this.value)"></td>
        <td><input type="number" min="0" max="${dist.hw[0]}" step="0.5" class="hw" value="${row.hw1 || ''}" oninput="updateRow(${i}, 'hw1', this.value)"></td>
        <td><input type="number" min="0" max="${dist.hw[1]}" step="0.5" class="hw" value="${row.hw2 || ''}" oninput="updateRow(${i}, 'hw2', this.value)"></td>
        <td><input type="number" min="0" max="${dist.hw[2]}" step="0.5" class="hw" value="${row.hw3 || ''}" oninput="updateRow(${i}, 'hw3', this.value)"></td>
        <td><input type="number" min="0" max="${dist.hw[3]}" step="0.5" class="hw" value="${row.hw4 || ''}" oninput="updateRow(${i}, 'hw4', this.value)"></td>
        <td><input type="number" min="0" max="${dist.handwriting}" step="0.5" class="handwriting" value="${row.handwriting || ''}" oninput="updateRow(${i}, 'handwriting', this.value)"></td>
        <td><input type="number" min="0" max="${dist.dictation}" step="0.5" class="dictation" value="${row.dictation || ''}" oninput="updateRow(${i}, 'dictation', this.value)"></td>
        <td class="sum-cell total-activity">${row.totalActivity || ''}</td>
        <td class="sum-cell total-hw">${row.totalHWPart || ''}</td>
        <td>
          <input type="number" min="0" max="${dist.written}" step="0.01" class="written"
            maxlength="5"
            value="${row.written || ''}"
            oninput="if(this.value.length>5)this.value=this.value.slice(0,5);studentRows[${i}].written=this.value;saveTableToStorage();">
        </td>
        <td class="sum-cell total-all">${row.totalAll || ''}</td>
        <td class="grade-estimate">${row.gradeTd || ''}</td>
        <td class="note-cell"><textarea oninput="updateRow(${i}, 'note', this.value)">${row.note || ''}</textarea></td>
      `;
      table.querySelector('tbody').appendChild(tr);
    }
    gradesTableContainer.appendChild(table);
    if (p < pages - 1) {
      let br = document.createElement('div');
      br.className = "page-break";
      gradesTableContainer.appendChild(br);
    }
  }
}
function updateRow(i, key, value) {
  studentRows[i][key] = value;
  calculateTotals();
  saveTableToStorage();
  renderTablePages();
}
function addRow() {
  studentRows.push({});
  renderTablePages();
  calculateTotals();
  saveTableToStorage();
}
function getGradeLabel(val) {
  if(val>=90) return {label:'ممتاز',      class:'badge-excellent',    row:'grade-color-excellent'};
  if(val>=75) return {label:'جيد جدًا',   class:'badge-vgood',        row:'grade-color-vgood'};
  if(val>=60) return {label:'جيد',        class:'badge-good',         row:'grade-color-good'};
  if(val>=45) return {label:'مقبول',      class:'badge-acceptable',   row:'grade-color-acceptable'};
  return           {label:'ضعيف',        class:'badge-weak',         row:'grade-color-weak'};
}
function calculateTotals() {
  let dist = getAdjustedDistribution();
  for(let i=0;i<studentRows.length;i++) {
    let row = studentRows[i];
    let act2_1 = +(row.act2_1||0), act2_2 = +(row.act2_2||0), reading = +(row.reading||0),
        memorize = +(row.memorize||0), act5 = +(row.act5||0);
    let totalActivity = act2_1 + act2_2 + reading + memorize + act5;
    row.totalActivity = totalActivity > 0 ? totalActivity : '';
    let hw1=+(row.hw1||0), hw2=+(row.hw2||0), hw3=+(row.hw3||0), hw4=+(row.hw4||0),
        handwriting=+(row.handwriting||0), dictation=+(row.dictation||0);
    let totalHWPart = hw1+hw2+hw3+hw4+handwriting+dictation;
    row.totalHWPart = totalHWPart > 0 ? totalHWPart : '';
    let written = +(row.written||0);
    let totalAll = +(totalActivity + totalHWPart + written).toFixed(2);
    row.totalAll = totalAll > 0 ? totalAll : '';
    row.gradeTd = '';
    row.gradeClass = '';
    if(totalAll > 0) {
      let g = getGradeLabel(totalAll);
      row.gradeTd = `<span class="grade-badge ${g.class}">${g.label}</span>`;
      row.gradeClass = g.row;
    }
  }
  renderTablePages();
  updateCurveChart();
}
function exportPdf() {
  calculateTotals();
  window.print();
}
function exportTableToExcel(containerId, filename = '') {
    calculateTotals();
    var className = document.getElementById('className').value || '';
    var monthName = document.getElementById('monthName').value || '';
    var filenameFinal = filename ? filename + '.xls' : 'دفتر تصحيح اللغة العربية.xls';
    // Header row
    let excelRows = [];
    excelRows.push([
      "م", "اسم الطالب الرباعي",
      "نشاط 1", "نشاط 2", "قراءة", "تسميع", "نش.صفي",
      "واجب 1", "واجب 2", "واجب 3", "واجب 4", "خط", "إملاء",
      "نشاط+", "واجب+", "تحريري", "المجموع", "التقدير"
    ]);
    // Build rows
    for (let i = 0; i < studentRows.length; i++) {
      let row = studentRows[i];
      excelRows.push([
        i+1,
        row.name || "",
        row.act2_1 || "",
        row.act2_2 || "",
        row.reading || "",
        row.memorize || "",
        row.act5 || "",
        row.hw1 || "",
        row.hw2 || "",
        row.hw3 || "",
        row.hw4 || "",
        row.handwriting || "",
        row.dictation || "",
        row.totalActivity || "",
        row.totalHWPart || "",
        row.written || "",
        row.totalAll || "",
        (row.gradeTd || "").replace(/<[^>]+>/g, "") // Remove HTML tags
      ]);
    }
    // Build HTML table for Excel
    let excelTable = `<table border="1" style="width:100%;font-family:'Cairo',Tahoma,Arial,sans-serif;text-align:center">`;
    excelTable += `<tr><th colspan="18" style="font-size:18px;font-weight:bold;color:#198754;">دفتر متابعة اللغة العربية - الأستاذ إبراهيم أحمد متاش</th></tr>`;
    excelTable += `<tr><th colspan="18" style="font-size:16px;">الصف: ${className} &nbsp;&nbsp; الشهر: ${monthName}</th></tr>`;
    for (let r = 0; r < excelRows.length; r++) {
      excelTable += "<tr>";
      for (let c = 0; c < excelRows[r].length; c++) {
        excelTable += (r === 0 ? "<th>" : "<td>") + (excelRows[r][c]) + (r === 0 ? "</th>" : "</td>");
      }
      excelTable += "</tr>";
    }
    excelTable += "</table>";
    // Full HTML for Excel
    let excelData = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>' + excelTable + '</body></html>';
    var blob = new Blob([excelData], {type: "application/vnd.ms-excel"});
    var downloadLink = document.createElement("a");
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = filenameFinal;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

function saveTableToStorage() {
  localStorage.setItem("arabic_grade_data_v6", JSON.stringify({
    studentRows,
    className: document.getElementById('className').value,
    monthName: document.getElementById('monthName').value,
    currentClassKey
  }));
}
function loadTableFromStorage() {
  let saved = localStorage.getItem("arabic_grade_data_v6");
  if (saved) {
    let {studentRows:rows, className, monthName, currentClassKey:ck} = JSON.parse(saved);
    if (Array.isArray(rows)) studentRows = rows;
    document.getElementById('className').value = className || '';
    document.getElementById('monthName').value = monthName || '';
    currentClassKey = ck || "";
  }
  renderTablePages();
  calculateTotals();
}
function resetAllData() {
  showConfirmModal(
    "تحذير هام",
    "هل أنت متأكد أنك تريد حذف جميع بيانات الطلاب والدرجات؟ لا يمكن التراجع عن هذه العملية!",
    function() {
      localStorage.removeItem("arabic_grade_data_v6");
      studentRows = [];
      renderTablePages();
      calculateTotals();
    }
  );
}
function exportBackup() {
  const backup = {
    studentRows,
    className: document.getElementById('className').value,
    monthName: document.getElementById('monthName').value,
    currentClassKey
  };
  const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = "arabic_grade_backup.json";
  link.click();
}
function importBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.studentRows) throw "ملف غير صالح";
      studentRows = data.studentRows;
      document.getElementById('className').value = data.className || '';
      document.getElementById('monthName').value = data.monthName || '';
      currentClassKey = data.currentClassKey || '';
      saveTableToStorage();
      renderTablePages();
      calculateTotals();
      alert("تمت الاستعادة بنجاح!");
    } catch (err) {
      alert("تعذر قراءة الملف. تأكد أن الملف من النموذج نفسه.");
    }
  };
  reader.readAsText(file);
}
window.addEventListener("DOMContentLoaded", function() {
  if (window.location.hash === "#unlocked") {
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = '';
    document.body.style.overflow = '';
  } else {
    document.getElementById('lockScreen').style.display = '';
    document.getElementById('mainApp').style.display = 'none';
    document.body.style.overflow = 'hidden';
  }
  loadTableFromStorage();
});

// رسم منحنى تركز النسب الأعلى
function updateCurveChart() {
  let allTotals = studentRows.map(row => +(row.totalAll || 0)).filter(x => x > 0);
  if (allTotals.length === 0) {
    if (window.curveChartObj) window.curveChartObj.destroy();
    document.getElementById('curveChart').style.display = "none";
    return;
  }
  document.getElementById('curveChart').style.display = "";
  // لنأخذ أعلى 10 درجات (أو أقل إذا لم يوجد)
  let sorted = [...allTotals].sort((a,b)=>b-a); // تنازلي
  let top = sorted.slice(0, Math.min(10, sorted.length));
  // عكس الترتيب ليظهر الأقل أولاً
  top = top.slice().reverse();
  let labels = top.map((v,i)=>`#${sorted.length-i}`);
  if (window.curveChartObj) window.curveChartObj.destroy();
  window.curveChartObj = new Chart(document.getElementById('curveChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: "أعلى الدرجات",
        data: top,
        borderColor: "#0d6efd",
        borderWidth: 2.5,
        fill: true,
        backgroundColor: "rgba(13,110,253,0.07)",
        pointRadius: 3.5,
        pointBackgroundColor: "#198754",
        tension: 0.45
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        x: { title: {display:true,text:'ترتيب أعلى الدرجات'}, grid:{display:false}, ticks:{font:{size:11}}},
        y: { title: {display:true,text:'الدرجة'}, min:0, max:100, grid:{display:false}, ticks:{stepSize:10,font:{size:11}} }
      },
      responsive: false,
      maintainAspectRatio: false
    }
  });
}
</script>
</body>
</html>